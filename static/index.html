<!DOCTYPE html>
<html>

<head>
  <title>Reunião WebRTC</title>
  <style>
    video {
      width: 300px;
      margin: 10px;
    }
  </style>
</head>

<body>
  <h2>Reunião WebRTC</h2>
  <input id="roomInput" placeholder="ID da Sala">
  <button onclick="joinRoom()">Entrar</button>
  <div id="videos"></div>

  <script>
    let localStream;
    let peers = {}; // peerID -> RTCPeerConnection
    let socket;
    let myID;

    async function joinRoom() {
      const room = document.getElementById("roomInput").value;
      socket = new WebSocket((location.protocol === 'https:' ? 'wss' : 'ws') + '://' + location.host + '/ws');

      socket.onopen = async () => {
        socket.send(JSON.stringify({type: 'join', room}));
        localStream = await navigator.mediaDevices.getUserMedia({video: true, audio: true});
        addVideoStream('local', localStream);
      };

      socket.onmessage = async (event) => {
        const msg = JSON.parse(event.data);
        if (msg.type === 'init') {
          myID = msg.id;
        } else if (msg.type === 'new-peer') {
          startConnection(msg.id, true);
        } else if (msg.type === 'offer') {
          startConnection(msg.from, false, msg);
        } else if (msg.type === 'answer') {
          peers[msg.from].setRemoteDescription(new RTCSessionDescription(msg.sdp));
        } else if (msg.type === 'candidate') {
          peers[msg.from].addIceCandidate(new RTCIceCandidate(msg.candidate));
        }
      };
    }

    function addVideoStream(id, stream) {
      let video = document.getElementById(id);
      if (!video) {
        video = document.createElement('video');
        video.id = id;
        video.autoplay = true;
        video.playsInline = true;
        document.getElementById('videos').appendChild(video);
      }
      video.srcObject = stream;
    }

    async function startConnection(peerID, isInitiator, offerMsg = null) {
      const pc = new RTCPeerConnection();
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = (event) => addVideoStream(peerID, event.streams[0]);
      pc.onicecandidate = (event) => {
        if (event.candidate) {
          socket.send(JSON.stringify({type: 'candidate', to: peerID, from: myID, candidate: event.candidate}));
        }
      };

      peers[peerID] = pc;

      if (isInitiator) {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        socket.send(JSON.stringify({type: 'offer', to: peerID, from: myID, sdp: offer}));
      } else {
        await pc.setRemoteDescription(new RTCSessionDescription(offerMsg.sdp));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        socket.send(JSON.stringify({type: 'answer', to: peerID, from: myID, sdp: answer}));
      }
    }
  </script>
</body>

</html>
